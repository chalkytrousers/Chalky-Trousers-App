<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chalky Trousers • Tournament Builder</title>
<style>
  :root{
    --bg:#000;
    --panel:#121212;
    --panel-2:#1b1b1b;
    --text:#fff;
    --muted:#bdbdbd;
    --brand:#12ff5a;
    --brand-dim:#0dbb41;
    --chip:#242424;
    --input:#0e0e0e;
    --card:#1a1a1a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
  img{display:block;max-width:100%}
  .wrap{max-width:980px;margin:0 auto;padding:16px 16px 60px}
  header{display:flex;align-items:center;gap:14px;margin:8px 0 18px}
  header .brand{height:34px;opacity:.95}
  h1{margin:0;font-size:clamp(22px,3.8vw,34px);letter-spacing:.4px}
  .panel{background:var(--panel);border-radius:18px;padding:18px 16px;margin:16px 0;box-shadow:0 0 0 1px #0b0b0b inset}
  .panel h2{margin:0 0 12px;font-size:clamp(20px,3.4vw,28px)}
  .underline{height:4px;width:160px;background:linear-gradient(90deg,var(--brand),transparent);border-radius:3px;margin:6px 0 14px}
  .hint{color:var(--muted);font-size:14px;line-height:1.5}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:720px){.grid-2{grid-template-columns:1fr}}
  .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);padding:8px 12px;border-radius:999px;color:#ddd;font-weight:600}
  .field{display:flex;flex-direction:column;gap:8px;margin:10px 0}
  label{font-weight:700}
  textarea{width:100%;min-height:210px;background:var(--input);border:1px solid #151515;color:var(--text);border-radius:12px;padding:14px;font-size:16px;line-height:1.5;resize:vertical}
  select{appearance:none;background:var(--input);border:1px solid #151515;color:var(--text);border-radius:12px;padding:12px 14px;font-size:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .btn{border:0;border-radius:12px;padding:12px 16px;font-weight:700;font-size:16px;color:#fff;cursor:pointer;background:#2a2a2a}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:#141414;box-shadow:0 0 18px 4px var(--brand-dim);position:relative}
  .btn-primary::after{content:"";position:absolute;inset:-2px;border-radius:12px;box-shadow:0 0 24px 6px var(--brand);opacity:.55;animation:pulse 1.8s ease-in-out infinite;z-index:-1}
  @keyframes pulse{0%,100%{opacity:.35}50%{opacity:.85}}
  .counter{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .tag{background:#0f0f0f;border:1px solid #151515;border-radius:999px;padding:8px 12px;color:#ddd;font-weight:700}
  /* BRACKET */
  .bracket-panel{background:var(--panel);border-radius:18px;padding:18px 12px}
  .rounds{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(250px,1fr);gap:14px;overflow-x:auto;padding-bottom:6px}
  .round{background:var(--panel-2);border-radius:16px;padding:14px;min-width:250px}
  .round h3{margin:0 0 10px;font-size:18px}
  .match{background:var(--card);border-radius:16px;padding:12px;margin:10px 0;border:1px solid #141414}
  .row2{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center}
  .side{display:flex;gap:10px;align-items:center;justify-content:space-between;background:#0f0f0f;border-radius:12px;padding:10px 12px;border:1px solid #161616}
  .name{font-weight:700}
  .score{width:54px;text-align:center;border-radius:10px;border:1px solid #242424;background:#0b0b0b;color:#fff;padding:8px 10px;font-weight:800;font-size:16px}
  .vs{color:var(--brand);font-weight:900;letter-spacing:.6px;text-shadow:0 0 10px var(--brand-dim);animation:pulsevs 3s ease-in-out infinite}
  @keyframes pulsevs{0%,100%{opacity:.75;text-shadow:0 0 6px var(--brand-dim)}50%{opacity:1;text-shadow:0 0 14px var(--brand)}}
  /* highlight winner only when decided */
  .side.win{box-shadow:0 0 0 2px var(--brand) inset}
  /* footer logo */
  footer{display:flex;justify-content:center;padding:28px 0 10px}
  footer img{height:64px;opacity:.9}
  /* file input visually hidden */
  #fileInput{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="brand" alt="Chalky Trousers"
           src="./assets/Chalky%20Trousers%20Logo%20(Text)%20800x500%20HR_20250927_180240_0001.png" />
      <h1>Tournament Builder</h1>
    </header>

    <section class="panel">
      <h2>Add players (one per line)</h2>
      <div class="underline"></div>

      <div class="chip">2–64 supported</div>

      <div class="field">
        <label class="sr-only" for="players">Players</label>
        <textarea id="players" placeholder="One name per line…">Alice
Bob
Charlie
Dana
Eddie
Frank
Georgia
Hector</textarea>
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="bestOf">Match length</label>
          <select id="bestOf">
            <option value="1">Best-of-1</option>
            <option value="3" selected>Best-of-3</option>
            <option value="5">Best-of-5</option>
          </select>
        </div>
        <div class="field">
          <label for="seeding">Seeding</label>
          <select id="seeding">
            <option value="random" selected>Random</option>
            <option value="alphabetical">Alphabetical</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <button id="fill" class="btn">Fill Test Names</button>
        <button id="generate" class="btn btn-primary">Generate Bracket</button>
        <button id="reset" class="btn">Reset</button>
      </div>

      <p class="hint" style="margin-top:12px">
        Tip: paste a list — we’ll trim blanks &amp; de-dupe. “Match length” sets required wins
        (e.g., best-of-3 → first to 2). Winners auto-advance as soon as both scores are entered and one side reaches the target.
      </p>

      <div class="counter" id="counterWrap" style="margin-top:10px">
        <span class="tag" id="countTag">0 entered (0 unique)</span>
        <span class="tag" id="formatTag">Format: —</span>
      </div>
    </section>

    <section class="panel">
      <div class="row" style="gap:10px;margin-bottom:10px">
        <button id="save" class="btn">Save</button>
        <button id="export" class="btn">Export JSON</button>
        <button id="import" class="btn">Import JSON</button>
        <input type="file" id="fileInput" accept="application/json" />
      </div>
      <ol class="hint" style="margin:0 0 4px 18px">
        <li><b>Autosave</b> keeps your latest bracket in this browser (no login needed).</li>
        <li><b>Export JSON</b> downloads a backup file.</li>
        <li><b>Import JSON</b> restores from a file (or paste if needed).</li>
      </ol>
    </section>

    <section class="bracket-panel">
      <h2 style="margin:0 0 6px">Bracket</h2>
      <div class="underline"></div>
      <div id="rounds" class="rounds" aria-live="polite"></div>
    </section>

    <footer>
      <img alt="Chalky player"
           src="./assets/Chalky%20Trousers%20Logo%20(Man)%20800x800%20HR_20250927_180303_0000.png" />
    </footer>
  </div>

<script>
/* -------------- Utilities -------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const stateKey = 'chalky.tourney.v0';

function getNames(){
  const raw = $('#players').value.split('\n')
    .map(s => s.trim()).filter(Boolean);
  // unique, case-insensitive – keep first seen
  const seen = new Set();
  const unique = [];
  for (const n of raw){
    const k = n.toLowerCase();
    if (!seen.has(k)){ seen.add(k); unique.push(n); }
  }
  return {rawCount: raw.length, unique};
}

function updateCounters(){
  const {rawCount, unique} = getNames();
  $('#countTag').textContent = `${rawCount} entered (${unique.length} unique)`;
  const best = parseInt($('#bestOf').value, 10);
  $('#formatTag').textContent = `Format: Single Elimination (Best-of-${best})`;
}

$('#players').addEventListener('input', updateCounters);
$('#bestOf').addEventListener('change', updateCounters);
updateCounters();

/* -------------- Bracket model -------------- */
let bracket = null; // { rounds:[ round:{matches:[{a:{name,score,entered}, b:{...}, target, winner, decided}]} ] }

function makePairs(list){
  const names = list.slice();
  if ($('#seeding').value === 'alphabetical'){
    names.sort((a,b)=>a.localeCompare(b));
  }else{
    // Fisher-Yates shuffle
    for (let i = names.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [names[i],names[j]]=[names[j],names[i]];
    }
  }
  // pad to next power of two with byes
  const nextPow = 1<<Math.ceil(Math.log2(Math.max(2, names.length)));
  while (names.length < nextPow) names.push({bye:true,name:'bye'});
  return names.map(n => (typeof n==='string'? {name:n}:{...n}));
}

function buildBracket(){
  const {unique} = getNames();
  if (unique.length < 2){ alert('Need at least 2 unique players.'); return; }
  const best = parseInt($('#bestOf').value,10);
  const target = Math.floor(best/2)+1;

  const entrants = makePairs(unique);
  const rounds = [];
  let current = [];

  // first round pairings
  for (let i=0;i<entrants.length;i+=2){
    current.push({
      a: entrants[i],
      b: entrants[i+1],
      target, winner:null, decided:false
    });
  }
  rounds.push({title: roundTitle(0, roundsNeeded(entrants.length)), matches: current});

  // subsequent rounds (empty placeholders)
  let remaining = entrants.length/2;
  while (remaining>=1){
    const m = [];
    for (let i=0;i<remaining/2;i++){
      m.push({a:{name:''}, b:{name:''}, target, winner:null, decided:false});
    }
    if (remaining>=1) rounds.push({title: roundTitle(rounds.length, roundsNeeded(entrants.length)), matches:m});
    remaining/=2;
  }

  bracket = {rounds, meta:{best,target}};
  // resolve any immediate bye winners in R1
  for (const match of rounds[0].matches){
    setWinnerIfReached(match);
  }
  propagateAll();
  renderBracket();
  persist();
}

function roundsNeeded(n){ return Math.log2(1<<Math.ceil(Math.log2(n))); }
function roundTitle(idx,total){
  const fromEnd = total-idx;
  if (fromEnd===1) return 'Final';
  if (fromEnd===2) return 'Semi-finals';
  if (fromEnd===3) return 'Quarter-finals';
  return `Round ${idx+1}`;
}

/* -------------- Decide matches / advancement -------------- */
function setWinnerIfReached(m){
  // handle byes
  if (m.a?.bye && !m.b?.bye){ m.winner=m.b; m.decided=true; return true; }
  if (m.b?.bye && !m.a?.bye){ m.winner=m.a; m.decided=true; return true; }
  if (m.a?.bye && m.b?.bye){ m.winner=m.a; m.decided=true; return true; }

  const a = m.a?.score ?? 0;
  const b = m.b?.score ?? 0;
  const bothEntered = !!m.a?.entered && !!m.b?.entered;
  const target = m.target;

  if (!bothEntered){ m.winner=null; m.decided=false; return false; }

  if (a >= target || b >= target){
    m.winner = (a > b) ? m.a : m.b;
    m.decided = true;
    return true;
  }
  m.winner=null; m.decided=false; return false;
}

function propagateAll(){
  if (!bracket) return;
  for (let r=0; r<bracket.rounds.length-1; r++){
    const cur = bracket.rounds[r].matches;
    const nxt = bracket.rounds[r+1].matches;
    for (let i=0;i<nxt.length;i++){
      const left = cur[i*2], right = cur[i*2+1];
      nxt[i].a = left?.winner ? {...left.winner} : {name:''};
      nxt[i].b = right?.winner ? {...right.winner} : {name:''};
      // reset scores/decision when participants change
      nxt[i].a.score = 0; nxt[i].a.entered = false;
      nxt[i].b.score = 0; nxt[i].b.entered = false;
      nxt[i].winner=null; nxt[i].decided=false;
    }
  }
}

/* -------------- Render -------------- */
function renderBracket(){
  const roundsEl = $('#rounds');
  roundsEl.innerHTML = '';
  if (!bracket){ return; }

  bracket.rounds.forEach((round,ri)=>{
    const rEl = document.createElement('div');
    rEl.className = 'round';
    rEl.innerHTML = `<h3>${round.title}</h3>`;
    round.matches.forEach((m,mi)=>{
      const card = document.createElement('div');
      card.className='match';
      const aName = m.a?.name || '—';
      const bName = m.b?.name || '—';
      const aScore = m.a?.score ?? 0;
      const bScore = m.b?.score ?? 0;

      card.innerHTML = `
        <div class="row2">
          <div class="side side-a"><span class="name">${escapeHtml(aName)}</span>
            <input class="score" type="number" min="0" value="${aScore}">
          </div>
          <div class="vs">VS</div>
          <div class="side side-b"><span class="name">${escapeHtml(bName)}</span>
            <input class="score" type="number" min="0" value="${bScore}">
          </div>
        </div>
      `;

      // apply winner highlight only when decided
      if (m.decided && m.winner){
        const leftEl = card.querySelector('.side-a');
        const rightEl = card.querySelector('.side-b');
        if (m.winner === m.a) leftEl.classList.add('win');
        if (m.winner === m.b) rightEl.classList.add('win');
      }

      // input handlers
      const aInput = card.querySelector('.side-a .score');
      const bInput = card.querySelector('.side-b .score');
      const onInput = () => {
        // ensure objects
        m.a = m.a || {name:aName};
        m.b = m.b || {name:bName};
        m.a.score = Math.max(0, parseInt(aInput.value||'0',10));
        m.b.score = Math.max(0, parseInt(bInput.value||'0',10));
        m.a.entered = true;
        m.b.entered = true;

        const decided = setWinnerIfReached(m);
        if (decided){
          // push winner forward
          propagateAll();
        }
        renderBracket(); // re-render to reflect highlights and next rounds
        persist();
      };
      aInput.addEventListener('input', onInput);
      bInput.addEventListener('input', onInput);

      rEl.appendChild(card);
    });
    roundsEl.appendChild(rEl);
  });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

/* -------------- Persistence -------------- */
function persist(){
  try{
    localStorage.setItem(stateKey, JSON.stringify({
      bracket, players: $('#players').value,
      bestOf: $('#bestOf').value, seeding: $('#seeding').value
    }));
  }catch(e){}
}
function loadPersisted(){
  try{
    const raw = localStorage.getItem(stateKey);
    if (!raw) return;
    const obj = JSON.parse(raw);
    if (obj.players) $('#players').value = obj.players;
    if (obj.bestOf) $('#bestOf').value = obj.bestOf;
    if (obj.seeding) $('#seeding').value = obj.seeding;
    updateCounters();
    if (obj.bracket){
      bracket = obj.bracket;
      renderBracket();
    }
  }catch(e){}
}
loadPersisted();

/* -------------- Controls -------------- */
$('#fill').addEventListener('click', ()=>{
  $('#players').value = `Alice
Bob
Charlie
Dana
Eddie
Frank
Georgia
Hector`;
  updateCounters();
});

$('#generate').addEventListener('click', buildBracket);

$('#reset').addEventListener('click', ()=>{
  if (!confirm('Clear players and bracket?')) return;
  $('#players').value='';
  updateCounters();
  bracket=null;
  renderBracket();
  persist();
});

$('#save').addEventListener('click', persist);

$('#export').addEventListener('click', ()=>{
  const data = {
    players: $('#players').value,
    bestOf: $('#bestOf').value,
    seeding: $('#seeding').value,
    bracket
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'chalky-tournament.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
});

$('#import').addEventListener('click', ()=>{
  // try file chooser first
  const finput = $('#fileInput');
  finput.value = '';
  finput.click();
});

$('#fileInput').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;
  try{
    const text = await file.text();
    applyImported(JSON.parse(text));
  }catch(err){
    // fallback to paste if file fails
    const pasted = prompt('Paste JSON:');
    if (!pasted) return;
    try{
      applyImported(JSON.parse(pasted));
    }catch(e2){
      alert('Invalid JSON.');
    }
  }
});

function applyImported(data){
  if (typeof data !== 'object'){ alert('Invalid JSON'); return; }
  if (typeof data.players === 'string') $('#players').value = data.players;
  if (data.bestOf) $('#bestOf').value = data.bestOf;
  if (data.seeding) $('#seeding').value = data.seeding;
  bracket = data.bracket || null;
  updateCounters();
  renderBracket();
  persist();
}
</script>
</body>
</html>
