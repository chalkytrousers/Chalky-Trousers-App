<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chalky Trousers – Tournament Builder</title>
<style>
  :root{
    --bg:#0a0a0a; --panel:#171717; --panel-2:#111;
    --text:#fff; --muted:#bdbdbd; --brand:#17ff5b; --brand-d:#0bbf44;
    --pill:#222; --accent:#22c55e;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:#000; color:var(--text);
  }
  .wrap{max-width:980px;margin:0 auto;padding:28px 16px 80px}
  header{display:flex;align-items:center;gap:14px;justify-content:center;margin-top:10px;margin-bottom:8px}
  header img.logo-man{width:72px;height:72px;object-fit:contain;filter:drop-shadow(0 0 0 rgba(0,0,0,0.6))}
  h1{margin:4px 0 12px;font-size:34px;text-align:center}
  .lead{max-width:760px;margin:0 auto 22px;text-align:center;color:var(--muted);line-height:1.55}
  .card{background:var(--panel);border-radius:16px;padding:18px;border:1px solid #202020;box-shadow:0 8px 24px rgba(0,0,0,.35);margin:18px 0}
  .card h3{margin:0 0 10px}
  textarea{
    width:100%;min-height:170px;border-radius:12px;border:1px solid #2a2a2a;background:var(--panel-2);
    color:var(--text);padding:14px;font-size:16px;outline:none;
  }
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .row.stacked > *{flex:1}
  .btn{
    background:#1f2937;border:1px solid #2b3440;color:#fff;padding:12px 16px;border-radius:12px;
    cursor:pointer;font-weight:600;letter-spacing:.2px
  }
  .btn:hover{background:#243041}
  .btn.primary{
    background:linear-gradient(180deg,#1d4ed8,#0b5fff 55%,#0b57d0);
    border:0; box-shadow:0 0 24px rgba(23,255,91,.25),0 0 2px rgba(23,255,91,.4);
  }
  .btn.primary:hover{filter:brightness(1.07)}
  .btn.ghost{background:#0e1116;border:1px solid #202532}
  .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted)}
  .pill{background:var(--pill);padding:8px 12px;border-radius:999px;border:1px solid #242424}
  .section-title{font-size:24px;margin:16px 0 8px;display:flex;align-items:center;gap:10px}
  .underline{height:3px;background:var(--brand);width:120px;border-radius:3px;margin:4px 0 0}
  /* bracket */
  .round{margin:14px 0 6px;font-weight:700}
  .grid{display:grid;gap:14px}
  .match{
    display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center;background:#131313;border:1px solid #242424;border-radius:16px;padding:12px;
  }
  .slot{
    display:flex;gap:10px;align-items:center;justify-content:space-between;background:#1a1a1a;border:1px solid #2a2a2a;
    padding:10px 12px;border-radius:12px;min-height:44px
  }
  .slot .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .vs{font-weight:800;color:#00ff6a;text-shadow:0 0 8px rgba(23,255,91,.55)}
  .win-btn{
    border:1px solid #2b2b2b;background:#0f172a;color:#cbd5e1;border-radius:10px;padding:6px 10px;cursor:pointer;font-size:13px
  }
  .win-btn:hover{background:#172036}
  .slot.winner{border-color:#22c55e;box-shadow:0 0 0 1px #22c55e inset}
  footer{margin-top:38px;text-align:center;color:#8b8b8b}
  footer img{width:200px;opacity:.92}
  .hint{color:#9aa2ad;font-size:13px;margin-top:8px}
  @media (min-width:720px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo-man" alt="Chalky Trousers" src="./assets/Chalky%20Trousers%20Logo%20(Man)%20800x800%20HR_20250927_180303_0000.png" />
      <h1>Tournament Builder</h1>
    </header>
    <p class="lead">Paste players, build a **single-elimination** bracket, click winners to advance. Everything autosaves to your browser; you can also Export/Import JSON.</p>

    <!-- Input Card -->
    <div class="card">
      <h3>Add players (one per line). 2–64 supported.</h3>
      <textarea id="playersInput" placeholder="Alice&#10;Bob&#10;Charlie"></textarea>
      <p class="hint">Tip: We’ll trim blanks &amp; de-dupe. Seeding is shuffled.</p>
      <div class="row">
        <button class="btn ghost" id="fillBtn">Fill Test Names</button>
        <button class="btn primary" id="genBtn">Generate Bracket</button>
      </div>
    </div>

    <!-- Controls -->
    <div class="card">
      <div class="row">
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn" id="exportBtn">Export JSON</button>
        <button class="btn" id="importBtn">Import JSON</button>
        <button class="btn ghost" id="resetBtn">Reset</button>
      </div>
      <p class="hint">All changes autosave under <code>chalky.tourney.v0</code>.</p>
    </div>

    <!-- Status -->
    <div class="card">
      <div class="meta">
        <span class="pill"><span id="playerCount">0</span> players</span>
        <span class="pill">Format: Single Elimination</span>
      </div>
      <div class="section-title">Bracket <div class="underline"></div></div>
      <div id="bracket"></div>
    </div>

    <footer>
      <img alt="Chalky Trousers" src="./assets/Chalky%20Trousers%20Logo%20(Text)%20800x500%20HR_20250927_180240_0001.png" />
    </footer>
  </div>

<script>
/* ------------------ State ------------------ */
const LS_KEY = 'chalky.tourney.v0';
let state = loadState() || { players: [], rounds: [] };

function saveState() {
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function loadState() {
  try { return JSON.parse(localStorage.getItem(LS_KEY)); }
  catch { return null; }
}
function setPlayersFromTextarea() {
  const raw = document.getElementById('playersInput').value
    .split('\n').map(s=>s.trim()).filter(Boolean);
  // de-duplicate while preserving order
  const seen = new Set(); const players=[];
  for (const n of raw){ if(!seen.has(n.toLowerCase())){ seen.add(n.toLowerCase()); players.push(n); } }
  state.players = players;
  saveState();
  renderMeta();
}

/* ------------------ Utilities ------------------ */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}
function nextPow2(n){ let p=1; while(p<n) p<<=1; return p; }

/* ------------------ Bracket Build ------------------ */
function buildBracket() {
  const players = [...state.players];
  if (players.length < 2) { state.rounds = []; saveState(); render(); return; }

  shuffle(players);
  const size = nextPow2(players.length);
  const byes = size - players.length;
  for (let i=0;i<byes;i++) players.push(null); // null = bye slot

  // Round 0 (first round)
  const round0 = [];
  for (let i=0;i<size;i+=2){
    round0.push({ a: players[i], b: players[i+1], winner: null });
  }

  // Prebuild empty rounds up to final
  const rounds = [round0];
  let matches = round0.length;
  while (matches > 1) {
    matches = Math.floor(matches/2);
    const r = [];
    for (let i=0;i<matches;i++) r.push({ a:null, b:null, winner:null });
    rounds.push(r);
  }
  state.rounds = rounds;
  propagateByes(); // move bye winners forward
  saveState();
  render();
}

function propagateByes() {
  // Automatically mark matches with a null opponent
  for (let r=0;r<state.rounds.length;r++){
    const round = state.rounds[r];
    for(let m=0;m<round.length;m++){
      const match = round[m];
      if (match.winner) continue;
      if (match.a && !match.b){ match.winner = match.a; }
      else if (!match.a && match.b){ match.winner = match.b; }
      if (match.winner) pushWinner(r,m,match.winner);
    }
  }
}

function pushWinner(r,m,player){
  const nextRound = state.rounds[r+1];
  if (!nextRound) return;
  const target = nextRound[Math.floor(m/2)];
  if (m%2===0) target.a = player; else target.b = player;
}

/* ------------------ Interactions ------------------ */
function markWinner(roundIndex, matchIndex, who){
  const match = state.rounds[roundIndex][matchIndex];
  const chosen = (who==='a') ? match.a : match.b;
  if (!chosen) return;

  match.winner = chosen;
  // clear downstream path before pushing to avoid stale names
  for (let r=roundIndex+1; r<state.rounds.length; r++){
    const idx = Math.floor(matchIndex / Math.pow(2, r-roundIndex));
    const m = state.rounds[r][idx];
    if (!m) break;
    if (r === roundIndex+1){
      if (matchIndex%2===0) m.a = null; else m.b = null;
    }
    m.winner = null;
  }
  pushWinner(roundIndex, matchIndex, chosen);
  saveState();
  render();
}

/* ------------------ Render ------------------ */
function renderMeta(){
  document.getElementById('playerCount').textContent = state.players.length;
}
function render(){
  // keep textarea in sync (only if it doesn't already match)
  const txt = state.players.join('\n');
  const el = document.getElementById('playersInput');
  if (el.value.trim() !== txt.trim()) el.value = txt;

  renderMeta();

  const host = document.getElementById('bracket');
  host.innerHTML = '';
  if (!state.rounds.length){
    host.innerHTML = '<p class="hint">No bracket yet. Add players and click “Generate Bracket”.</p>';
    return;
  }

  const titles = ['Round 1','Quarter-finals','Semi-finals','Final','Winner'];
  state.rounds.forEach((round, rIdx)=>{
    const title = document.createElement('div');
    title.className='round';
    let label = titles[Math.min(titles.length-2, Math.max(0, state.rounds.length - rIdx))];
    if (rIdx === state.rounds.length-1) label = 'Final';
    if (state.rounds.length===1) label='Final';
    title.textContent = label;
    host.appendChild(title);

    const grid=document.createElement('div');
    grid.className='grid';
    round.forEach((m, i)=>{
      const row=document.createElement('div');
      row.className='match';

      const slotA=document.createElement('div');
      slotA.className='slot' + (m.winner===m.a && m.a ? ' winner':'');
      slotA.innerHTML = `<span class="name">${m.a ?? '<i>bye</i>'}</span>`;
      const btnA=document.createElement('button');
      btnA.className='win-btn';
      btnA.textContent='Win';
      btnA.disabled = !m.a;
      btnA.onclick=()=>markWinner(rIdx,i,'a');
      slotA.appendChild(btnA);

      const vs=document.createElement('div'); vs.className='vs'; vs.textContent='VS';

      const slotB=document.createElement('div');
      slotB.className='slot' + (m.winner===m.b && m.b ? ' winner':'');
      slotB.innerHTML = `<span class="name">${m.b ?? '<i>bye</i>'}</span>`;
      const btnB=document.createElement('button');
      btnB.className='win-btn';
      btnB.textContent='Win';
      btnB.disabled = !m.b;
      btnB.onclick=()=>markWinner(rIdx,i,'b');
      slotB.appendChild(btnB);

      row.appendChild(slotA); row.appendChild(vs); row.appendChild(slotB);
      grid.appendChild(row);
    });
    host.appendChild(grid);
  });

  // If final has a winner, show champion
  const last = state.rounds[state.rounds.length-1][0];
  if (last && last.winner){
    const title=document.createElement('div'); title.className='round'; title.textContent='Champion';
    const chip=document.createElement('div'); chip.className='pill'; chip.style.marginTop='6px'; chip.textContent=last.winner;
    host.appendChild(title); host.appendChild(chip);
  }
}

/* ------------------ Export / Import / Save / Reset ------------------ */
function doSave(){ saveState(); alert('Saved to this browser.'); }

function exportJSON(){
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'chalky-tournament.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function importJSON(){
  const input = document.createElement('input');
  input.type = 'file'; input.accept='.json,application/json';
  input.addEventListener('change', (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        const data = JSON.parse(ev.target.result);
        if (!data || !Array.isArray(data.players) || !Array.isArray(data.rounds)) {
          alert('Invalid JSON structure.'); return;
        }
        state = data; saveState(); render(); alert('✅ Tournament imported.');
      }catch(err){ alert('⚠️ Could not parse JSON.'); }
    };
    reader.readAsText(file);
  });
  input.click();
}

function resetAll(){
  if (!confirm('Reset everything?')) return;
  state = { players: [], rounds: [] };
  saveState(); render();
}

/* ------------------ Wire up ------------------ */
document.getElementById('fillBtn').onclick = ()=>{
  document.getElementById('playersInput').value =
`Alice
Bob
Charlie
Dana
Eddie
Frank
Georgia
Hector`;
  setPlayersFromTextarea();
};
document.getElementById('genBtn').onclick = ()=>{ setPlayersFromTextarea(); buildBracket(); };
document.getElementById('saveBtn').onclick = doSave;
document.getElementById('exportBtn').onclick = exportJSON;
document.getElementById('importBtn').onclick = importJSON;
document.getElementById('resetBtn').onclick = resetAll;
document.getElementById('playersInput').addEventListener('input', ()=>{ setPlayersFromTextarea(); });

/* ------------------ Init ------------------ */
(function init(){
  if (state.players?.length) document.getElementById('playersInput').value = state.players.join('\n');
  render();
})();
</script>
</body>
</html>
