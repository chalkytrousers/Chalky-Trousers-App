<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chalky Trousers – Tournament Builder</title>
<style>
  :root{
    --bg:#000; --panel:#141414; --chip:#1c1c1c; --soft:#101010;
    --text:#f7f7f7; --muted:#b9b9b9; --accent:#23ff4f; --accent-d:#16d73a; --danger:#ff5f5f;
    --colw:320px;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:26px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  header img{height:42px;width:auto}
  h1{font-size:26px;margin:0}

  .card{background:var(--panel);border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 0 0 1px #0c0c0c inset}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row.end{justify-content:flex-end}
  .split{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
  .underline{border-bottom:2px solid var(--accent);display:inline-block;padding-bottom:2px}

  textarea{width:100%;min-height:160px;border:0;border-radius:12px;background:var(--chip);color:var(--text);font-size:16px;padding:12px;outline:none}
  select{background:var(--chip);color:var(--text);border:0;border-radius:10px;padding:10px 12px;font-size:15px}

  .btn{appearance:none;border:0;background:#111;color:#fff;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
  .btn.primary{position:relative;box-shadow:0 0 22px 6px rgba(35,255,79,.22);animation:pulseBtn 1.6s ease-in-out infinite}
  .btn.ghost{background:var(--chip);box-shadow:none}
  .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none;animation:none}
  @keyframes pulseBtn{
    0%{box-shadow:0 0 6px 2px rgba(35,255,79,.12)}
    50%{box-shadow:0 0 28px 10px rgba(35,255,79,.38)}
    100%{box-shadow:0 0 6px 2px rgba(35,255,79,.12)}
  }
  .btn.warnpulse{animation:warn 1.1s ease-in-out 2}
  @keyframes warn{
    0%{box-shadow:0 0 0 0 rgba(255,95,95,0)}
    50%{box-shadow:0 0 24px 8px rgba(255,95,95,.45)}
    100%{box-shadow:0 0 0 0 rgba(255,95,95,0)}
  }

  .tag{background:#0e0e0e;border:1px solid #1b1b1b;color:var(--muted);padding:6px 10px;border-radius:999px;font-weight:800}
  .tag.warn{background:#2a1010;border-color:#3a1b1b;color:#ff9f9f}

  .hint{color:var(--muted);font-size:14px;margin-top:10px}

  /* Bracket layout */
  .bracket{overflow-x:auto;overflow-y:hidden;padding-bottom:8px}
  .cols{display:flex;gap:14px}
  .round-col{flex:0 0 var(--colw);min-width:var(--colw)}
  .round-title{font-weight:900;margin:4px 0 10px}

  .match{background:var(--soft);border-radius:16px;padding:12px;margin-bottom:12px;box-shadow:0 0 0 1px #0e0e0e inset}
  .match-row{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
  .box{background:var(--chip);border-radius:12px;padding:8px 10px;display:flex;align-items:center;justify-content:space-between;gap:8px;min-height:44px}
  .name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .bye{font-style:italic;color:var(--muted);font-weight:600}
  .score{display:flex;align-items:center;gap:6px;flex:0 0 auto}
  .score input{width:50px;text-align:center;background:#0c0c0c;border:1px solid #222;border-radius:10px;color:#fff;padding:6px}
  .vs{font-weight:900;color:var(--accent);text-shadow:0 0 6px var(--accent-d);animation:pulseVS 2.6s ease-in-out infinite}
  @keyframes pulseVS{
    0%{opacity:.65; text-shadow:0 0 2px var(--accent)}
    50%{opacity:1; text-shadow:0 0 14px var(--accent)}
    100%{opacity:.65; text-shadow:0 0 2px var(--accent)}
  }

  .logo-foot{margin-top:12px;text-align:center;opacity:.9}
  .logo-foot img{height:40px;width:auto}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="./assets/Chalky%20Trousers%20Logo%20(Text)%20800x500%20HR_20250927_180240_0001.png" alt="Chalky Trousers" />
    <h1>Tournament Builder</h1>
  </header>

  <!-- Player entry -->
  <section class="card">
    <div class="split">
      <h2 class="underline">Add players (one per line)</h2>
      <span class="tag">2–64 supported</span>
    </div>

    <textarea id="players" placeholder="Alice
Bob
Charlie
Dana"></textarea>

    <div class="row" style="margin-top:10px">
      <div>
        <label for="series"><strong>Match length</strong></label><br/>
        <select id="series">
          <option value="1">Single game (best-of-1)</option>
          <option value="3" selected>Best-of-3</option>
          <option value="5">Best-of-5</option>
        </select>
      </div>
      <div>
        <label for="seed"><strong>Seeding</strong></label><br/>
        <select id="seed">
          <option value="random" selected>Random</option>
          <option value="list">Use list order</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <!-- order: Fill Test Names, then Generate -->
      <button class="btn ghost" id="fillBtn">Fill Test Names</button>
      <button class="btn primary" id="genBtn">Generate Bracket</button>
      <button class="btn ghost" id="resetBtn">Reset</button>
    </div>

    <p class="hint">
      Tip: paste a list — we’ll trim blanks & de-dupe. “Match length” sets required wins
      (e.g., best-of-3 → first to 2). Winners auto-advance when a side reaches the target.
    </p>
  </section>

  <!-- Save / Load -->
  <section class="card">
    <div class="split">
      <div class="row">
        <div class="tag" id="metaPlayers">0 entered (0 unique)</div>
        <div class="tag warn" id="metaDupes" style="display:none"></div>
      </div>
      <div class="tag" id="metaFormat">Format: Single Elimination (Best-of-3)</div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" id="saveBtn">Save</button>
      <button class="btn ghost" id="exportBtn">Export JSON</button>
      <button class="btn ghost" id="importBtn">Import JSON</button>
    </div>
    <ol class="hint" style="margin-top:10px">
      <li><strong>Autosave</strong> keeps your latest bracket in this browser.</li>
      <li><strong>Export JSON</strong> downloads a backup file.</li>
      <li><strong>Import JSON</strong> restores from a file (with paste fallback if needed).</li>
    </ol>
  </section>

  <!-- Bracket -->
  <section class="card">
    <h2 class="underline">Bracket</h2>
    <div class="bracket" id="bracket">
      <div class="hint">Add players and tap <strong>Generate Bracket</strong> to begin.</div>
    </div>
    <div class="logo-foot">
      <img src="./assets/Chalky%20Trousers%20Logo%20(Man)%20800x800%20HR_20250927_180303_0000.png" alt="Chalky Man" />
    </div>
  </section>
</div>

<script>
/* ---------- State ---------- */
const LS_KEY = 'chalky.tourney.v3';
let state = { players:[], rounds:[], series:3, seed:'random' };

const $ = s => document.querySelector(s);

/* ---------- Helpers ---------- */
function uniqList(lines){
  return [...new Set(lines.map(s=>s.trim()).filter(Boolean).map(v=>v.toLowerCase()))]
    .map(lower => {
      const srcIdx = lines.findIndex(x => x.trim().toLowerCase() === lower);
      return lines[srcIdx].trim();
    });
}
function parsePlayersText(txt){
  const lines = txt.split('\n').map(s=>s.trim()).filter(Boolean);
  const raw = lines.length;
  const seen = new Set(); let dup=0;
  for(const n of lines){ const k=n.toLowerCase(); if(seen.has(k)) dup++; else seen.add(k); }
  return { rawCount:raw, uniqueCount:seen.size, dupCount:dup };
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function requiredWins(series){ return Math.floor(series/2)+1; }
function nextPow2(n){ let p=1; while(p<n) p<<=1; return Math.max(2,p); }

/* ---------- Round building ---------- */
function buildFirstRound(players){
  const n = players.length, size = nextPow2(n), byes = size - n;
  const list = players.slice(); for(let i=0;i<byes;i++) list.push(null);
  const matches=[];
  for(let i=0;i<list.length;i+=2){
    const m={a:list[i],b:list[i+1],scoreA:0,scoreB:0,winner:null};
    if(m.a && !m.b) m.winner=m.a;
    if(!m.a && m.b) m.winner=m.b;
    matches.push(m);
  }
  return matches;
}
function buildEmptyNextRound(prev){
  const next=[]; for(let i=0;i<prev.length;i+=2)
    next.push({a:null,b:null,scoreA:0,scoreB:0,winner:null});
  return next;
}
function seedIntoNextRound(roundIdx){
  if(roundIdx>=state.rounds.length-1) return;
  const cur=state.rounds[roundIdx], nxt=state.rounds[roundIdx+1];
  for(let i=0;i<nxt.length;i++){
    const L=cur[2*i]?.winner ?? null, R=cur[2*i+1]?.winner ?? null;
    nxt[i].a=L; nxt[i].b=R;
    if(L && !R) nxt[i].winner=L;
    else if(!L && R) nxt[i].winner=R;
    else if(!L && !R) nxt[i].winner=null;
  }
}
function roundTitles(count){
  const names=[]; for(let i=0;i<count;i++){
    const left=count-i;
    if(left===1) names.push('Final');
    else if(left===2) names.push('Semi-finals');
    else if(left===3) names.push('Quarter-finals');
    else names.push(`Round ${i+1}`);
  } return names;
}

/* ---------- Render ---------- */
function render(){
  $('#metaFormat').textContent=`Format: Single Elimination (Best-of-${state.series})`;
  const host=$('#bracket'); host.innerHTML='';

  if(state.rounds.length===0){
    host.innerHTML='<div class="hint">Add players and tap <strong>Generate Bracket</strong> to begin.</div>';
    return;
  }

  const cols=document.createElement('div'); cols.className='cols';
  const titles=roundTitles(state.rounds.length);

  state.rounds.forEach((round,rIdx)=>{
    const col=document.createElement('div'); col.className='round-col';

    const rt=document.createElement('div'); rt.className='round-title'; rt.textContent=titles[rIdx];
    col.appendChild(rt);

    round.forEach((m,mIdx)=>{
      const card=document.createElement('div'); card.className='match';
      const row=document.createElement('div'); row.className='match-row';

      const boxA=document.createElement('div'); boxA.className='box';
      boxA.innerHTML=`<span class="name">${m.a?m.a:'<span class="bye">bye</span>'}</span>`;
      const scA=document.createElement('div'); scA.className='score';
      const inA=document.createElement('input'); inA.type='number'; inA.min='0'; inA.step='1'; inA.value=m.scoreA||0;
      inA.disabled=!(m.a && m.b); scA.appendChild(inA); boxA.appendChild(scA);

      const vs=document.createElement('div'); vs.className='vs'; vs.textContent='VS';

      const boxB=document.createElement('div'); boxB.className='box';
      boxB.innerHTML=`<span class="name">${m.b?m.b:'<span class="bye">bye</span>'}</span>`;
      const scB=document.createElement('div'); scB.className='score';
      const inB=document.createElement('input'); inB.type='number'; inB.min='0'; inB.step='1'; inB.value=m.scoreB||0;
      inB.disabled=!(m.a && m.b); scB.appendChild(inB); boxB.appendChild(scB);

      if(m.winner){ if(m.winner===m.a) boxA.style.boxShadow='0 0 0 2px var(--accent) inset';
                    if(m.winner===m.b) boxB.style.boxShadow='0 0 0 2px var(--accent) inset'; }

      if(m.a && m.b){
        const onInput=()=>{
          m.scoreA=parseInt(inA.value||'0',10);
          m.scoreB=parseInt(inB.value||'0',10);
          const need=requiredWins(state.series);
          let w=null;

          if(state.series===1){
            if(inA.value!=='' && inB.value!==''){
              if(m.scoreA>m.scoreB) w=m.a; else if(m.scoreB>m.scoreA) w=m.b;
            }
          }else{
            if(m.scoreA>=need || m.scoreB>=need){
              if(m.scoreA!==m.scoreB) w=(m.scoreA>m.scoreB)?m.a:m.b;
            }
          }
          m.winner=w;
          seedIntoNextRound(rIdx);
          for(let i=rIdx+1;i<state.rounds.length;i++) seedIntoNextRound(i);
          saveLS(); render();
        };
        inA.addEventListener('input',onInput);
        inB.addEventListener('input',onInput);
      }

      row.appendChild(boxA); row.appendChild(vs); row.appendChild(boxB);
      card.appendChild(row); col.appendChild(card);
    });

    cols.appendChild(col);
  });

  host.appendChild(cols);
}

/* ---------- Player meta + guards ---------- */
function updatePlayerMeta(){
  const {rawCount,uniqueCount,dupCount}=parsePlayersText($('#players').value);
  $('#metaPlayers').textContent=`${rawCount} entered (${uniqueCount} unique)`;
  const dupEl=$('#metaDupes'); const gen=$('#genBtn');
  if(dupCount>0){ dupEl.style.display=''; dupEl.textContent=`${dupCount} duplicate${dupCount===1?'':'s'}`; }
  else dupEl.style.display='none';
  gen.disabled = !(uniqueCount>=2 && dupCount===0);
}

/* ---------- Actions ---------- */
function generate(){
  // if disabled, flash red so it’s obvious why
  if($('#genBtn').disabled){
    $('#genBtn').classList.remove('warnpulse'); void $('#genBtn').offsetWidth; $('#genBtn').classList.add('warnpulse');
    return;
  }
  const lines=$('#players').value.split('\n').map(s=>s.trim());
  let players=uniqList(lines);
  if($('#seed').value==='random') shuffle(players);

  state.players=players;
  state.series=parseInt($('#series').value,10)||3;
  state.seed=$('#seed').value;

  const first=buildFirstRound(players);
  const rounds=[first]; let cur=first;
  while(cur.length>1){ const nxt=buildEmptyNextRound(cur); rounds.push(nxt); cur=nxt; }
  state.rounds=rounds;

  for(let i=0;i<state.rounds.length-1;i++) seedIntoNextRound(i);
  saveLS(); render();
}

function fillTest(){
  $('#players').value=`Alice
Bob
Charlie
Dana
Eddie
Frank
Georgia
Hector`;
  updatePlayerMeta();
}
function resetAll(){
  if(!confirm('Clear players and bracket?')) return;
  state={players:[],rounds:[],series:3,seed:'random'};
  saveLS();
  $('#players').value='';
  $('#bracket').innerHTML='<div class="hint">Add players and tap <strong>Generate Bracket</strong> to begin.</div>';
  updatePlayerMeta();
}

/* ---------- Persistence & JSON ---------- */
function saveLS(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadLS(){
  const raw=localStorage.getItem(LS_KEY); if(!raw) return false;
  try{ const obj=JSON.parse(raw); if(!obj||!Array.isArray(obj.rounds)) return false; state=obj; return true; }
  catch{ return false; }
}
function download(filename,text){
  const blob=new Blob([text],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
}
function exportJSON(){ download('chalky-tournament.json', JSON.stringify(state,null,2)); }
function importJSON(){
  const input=document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange=e=>{
    const file=e.target.files?.[0]; if(!file) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const obj=JSON.parse(r.result);
        if(!obj||!Array.isArray(obj.rounds)) throw 0;
        state=obj; saveLS(); render(); updatePlayerMeta();
      }catch{ alert('Invalid JSON file.'); }
    };
    r.readAsText(file);
  };
  input.click();
}

/* ---------- Wire up ---------- */
$('#fillBtn').addEventListener('click', fillTest);
$('#genBtn').addEventListener('click', generate);
$('#resetBtn').addEventListener('click', resetAll);
$('#saveBtn').addEventListener('click', saveLS);
$('#exportBtn').addEventListener('click', exportJSON);
$('#importBtn').addEventListener('click', importJSON);

$('#players').addEventListener('input', updatePlayerMeta);
$('#series').addEventListener('change', ()=>{ state.series=parseInt($('#series').value,10)||3; $('#metaFormat').textContent=`Format: Single Elimination (Best-of-${state.series})`; });
$('#seed').addEventListener('change', ()=>{ state.seed=$('#seed').value; });

/* ---------- Init ---------- */
if(loadLS()){ render(); }
updatePlayerMeta();
</script>
</body>
</html>
