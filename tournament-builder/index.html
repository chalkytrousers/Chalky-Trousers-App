<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chalky Trousers ‚Äî Knockout Bracket</title>
<link rel="icon" href="/Chalky-Trousers-App/assets/Chalky%20Trousers%20Logo%20(Man)%20800x800%20HR_20250927_180303_0000.png">
<style>
  :root{
    --bg:#0b0b0b; --card:#161616; --muted:#9aa3a7; --text:#fff;
    --accent:#22ff6d; --accent-dim:#0d3;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:#000; color:#fff;
  }
  .wrap{max-width:1100px; margin:0 auto; padding:24px 16px 64px}

  /* Header (same as homepage) */
  header{
    margin-top: 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    text-align: center;
  }
  header img { width: 220px; max-width: 80%; }
  header h1 {
    font-size: 1.8rem; margin-top: 10px; color: #fff; letter-spacing: 1px;
  }
  header p {
    color: #9aa3a7; max-width: 650px; margin: 0 auto 20px;
    line-height: 1.6em; font-size: 1rem;
  }
  .brand-intro{
    color:#9aa3a7; font-size:1.05rem; line-height:1.7em;
    max-width:700px; margin:10px auto 20px;
  }
  .brand-intro em{ color:#ddd; font-style:normal; }
  .back-btn{
    display:inline-block; margin:20px auto 30px; background:#111; color:#fff;
    border:1px solid #1f1f1f; border-radius:10px; padding:10px 18px; font-size:15px;
    text-decoration:none; transition:background .2s ease, transform .1s ease;
  }
  .back-btn:hover{ background:#151515; transform:translateY(-2px); }

  /* Existing app styles */
  .lead{
    background:var(--card); border-radius:14px; padding:18px;
    display:grid; gap:16px; margin-bottom:18px;
  }
  .lead h2{margin:0 0 6px; font-size:18px}
  textarea{
    width:100%; min-height:160px; resize:vertical; border:0; outline:0;
    border-radius:10px; padding:12px; background:#0f0f0f; color:#fff; font-size:15px;
  }
  .row{display:flex; gap:10px; flex-wrap:wrap}
  button{
    background:#1b1b1b; color:#fff; border:0; border-radius:10px; padding:12px 16px;
    font-weight:600; cursor:pointer; transition:transform .05s ease, box-shadow .25s ease;
    box-shadow:0 0 18px 0 rgba(34,255,109,0.0);
  }
  button.primary{ background:#111; box-shadow:0 0 24px 4px rgba(34,255,109,.15); }
  button:hover{transform:translateY(-1px)}
  .pill{background:#0e0e0e; color:#cfd6d9; border:1px solid #1f1f1f; padding:8px 12px; border-radius:999px; font-size:13px}

  .bracket-wrap{background:var(--card); border-radius:16px; padding:18px; margin-top:18px;}
  .bracket-head{display:flex; align-items:center; gap:10px; margin-bottom:12px}
  .underline{height:3px; width:160px; background:var(--accent); border-radius:3px}
  .scroller{overflow-x:auto; padding-bottom:10px; margin:-6px; padding:6px;}
  .grid{display:grid; grid-auto-flow:column; grid-auto-columns:minmax(250px, 1fr); gap:16px; min-height:180px}
  .round{display:flex; flex-direction:column; gap:16px}
  .round-title{color:#bcd; font-weight:700; margin-bottom:2px}
  .match{background:#121212; border:1px solid #1f1f1f; border-radius:14px; padding:12px;}

  .slot{
    display:grid; grid-template-columns:minmax(0,1fr) 48px 50px; align-items:center; gap:8px;
    background:#0f0f0f; border:1px solid #1d1d1d; border-radius:12px; padding:10px 12px; margin-bottom:10px;
  }
  .slot.empty{opacity:.55; font-style:italic}
  .slot > span{min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

  .vs{text-align:center; color:var(--accent); font-weight:800; letter-spacing:1px; margin:6px 0}

  .score{
    width:48px; min-width:48px; text-align:center;
    border:1px solid #262626; border-radius:10px;
    background:#101010; color:#fff; padding:6px 4px; font-weight:700;
  }
  .win-btn{
    min-width:50px; text-align:center;
    background:#0c1320; border:1px solid #1f2a3a; color:#d4e7ff;
    padding:6px 8px; border-radius:999px; font-size:13px;
  }
  .win-btn.active{background:#153a22; border-color:#1d5a36; color:#bff5d4}

  .notice{color:#a8b2b8; font-size:13px}
  .footer-actions{margin-top:14px; display:flex; flex-wrap:wrap; gap:10px}

  @media (max-width:640px){
    header h1{font-size:18px}
    .grid{grid-auto-columns:minmax(220px, 1fr)}
  }
  @media (max-width:420px){
    .slot{ grid-template-columns: minmax(0,1fr) 42px 48px; gap:6px; }
    .score{ width:42px; min-width:42px; }
    .slot > span{ font-size:.95rem; }
  }

  /* Footer (same as homepage) */
  footer{ margin:60px 0 25px; opacity:.85; text-align:center; }
  footer img{ width:120px; margin-bottom:10px; }
  .contact{
    font-size:.95rem; color:#9aa3a7; margin-top:8px;
    display:flex; flex-direction:column; align-items:center; gap:6px;
  }
  .contact a{ color:#ddd; text-decoration:none; font-weight:600; transition:color .2s ease; }
  .contact a:hover{ color:#fff; }
  .contact span{ display:flex; align-items:center; gap:6px; }
</style>
</head>
<body>
  <div class="wrap">

    <!-- Header -->
    <header>
      <img src="/Chalky-Trousers-App/assets/Chalky%20Trousers%20Logo%20(Text)%20800x500%20HR_20250927_180240_0001.png" alt="Chalky Trousers Logo">
      <h1>Chalky Trousers ‚Äî Knockout Bracket</h1>
      <p>A growing collection of tools for the cue sports community ‚Äî built by Chalky Trousers.</p>
      <div class="brand-intro">
        <strong>Chalky Trousers</strong> is a cue sports brand for players who care about quality, precision, and the small details that make the game feel good ‚Äî
        <em>for players who take their game seriously, even if they don‚Äôt take themselves too seriously.</em>
      </div>
      <a href="/Chalky-Trousers-App/" class="back-btn">‚Üê Back to Home</a>
    </header>

    <!-- App UI -->
    <section class="lead">
      <div>
        <h2>Add players (one per line)</h2>
        <p class="notice">2‚Äì64 supported. We‚Äôll auto-add <em>byes</em> to reach a power of two.</p>
        <textarea id="playersBox" placeholder="Alice
Bob
Charlie
Dana"></textarea>
      </div>
      <div class="row">
        <button class="primary" id="genBtn">Generate Bracket</button>
        <button id="fillBtn">Fill Test Names</button>
        <span class="pill" id="countPill">0 players</span>
      </div>
      <div class="footer-actions">
        <button id="saveBtn">Save</button>
        <button id="exportBtn">Export JSON</button>
        <button id="importBtn">Import JSON</button>
        <button id="resetBtn">Reset</button>
        <span class="notice">Autosaves to <code>chalky.tourney.v0</code>.</span>
      </div>
    </section>

    <section class="bracket-wrap" id="bracketWrap" style="display:none;">
      <div class="bracket-head">
        <h2 style="margin:0">Bracket</h2>
        <div class="underline"></div>
      </div>
      <div class="scroller">
        <div class="grid" id="grid"></div>
      </div>
    </section>

    <!-- Footer -->
    <footer>
      <img src="/Chalky-Trousers-App/assets/Chalky%20Trousers%20Logo%20(Man)%20800x800%20HR_20250927_180303_0000.png" alt="Chalky Trousers Icon Logo">
      <div class="contact">
        <span>üìß <a href="mailto:jamie@chalkytrousers.co.uk">jamie@chalkytrousers.co.uk</a></span>
        <span>üì∑ <a href="https://instagram.com/chalkytrousers" target="_blank">@chalkytrousers</a></span>
      </div>
    </footer>
  </div>

<script>
/* ---------- utilities ---------- */
const storeKey = 'chalky.tourney.v0';
const $ = sel => document.querySelector(sel);
const el = (tag, cls, txt) => { const n=document.createElement(tag); if(cls) n.className=cls; if(txt!=null) n.textContent=txt; return n; };
const toNextPow2 = n => (n<2?2:1<<Math.ceil(Math.log2(n)));
const titleForRound = (r, total) => {
  const fromEnd = total - r;
  if(fromEnd===1) return 'Final';
  if(fromEnd===2) return 'Semi-finals';
  if(fromEnd===3) return 'Quarter-finals';
  return `Round ${r+1}`;
};

function cleanNames(raw){
  return raw.split('\n')
    .map(s=>s.trim())
    .filter(Boolean)
    .filter((v,i,a)=>a.indexOf(v)===i); // de-dupe
}

/* ---------- state ---------- */
let bracket = null; // { rounds: [ [ {p1, p2, winnerIndex, s1, s2}, ... ], ... ], players: [...] }

/* ---------- build bracket (no bye-vs-bye in R1) ---------- */
function buildBracket(players){
  const size = toNextPow2(players.length);
  let byes = size - players.length;

  const playerQueue = [...players];
  const matchesInRound0 = size / 2;
  const round0 = [];

  for (let i = 0; i < matchesInRound0; i++) {
    let p1, p2;

    const remainingMatches = matchesInRound0 - i;
    // Spread at most one BYE per match while possible
    if (byes > 0 && playerQueue.length > remainingMatches) {
      p1 = playerQueue.shift() || 'bye';
      p2 = 'bye';
      byes--;
    } else {
      p1 = playerQueue.shift() || 'bye';
      p2 = playerQueue.shift() || 'bye';
      if (p1 === 'bye' && p2 !== 'bye') [p1, p2] = [p2, p1];
      if (p1 === 'bye' && p2 === 'bye' && playerQueue.length) {
        p1 = playerQueue.shift();
      }
    }

    round0.push({ p1, p2, winnerIndex:null, s1:null, s2:null });
  }

  const rounds = [round0];
  let matches = matchesInRound0;
  while (matches > 1) {
    matches = matches / 2;
    rounds.push(new Array(matches).fill(0).map(_ => ({p1:'', p2:'', winnerIndex:null, s1:null, s2:null})));
  }

  return { players: [...players], rounds };
}

function autosave(){
  if(!bracket) return;
  localStorage.setItem(storeKey, JSON.stringify(bracket));
}
function loadSaved(){
  const raw = localStorage.getItem(storeKey);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch(_) { return null; }
}

/* ---------- advancement helpers ---------- */
function advanceWinner(rIndex, mIndex){
  const round = bracket.rounds[rIndex];
  const match = round[mIndex];
  if(rIndex >= bracket.rounds.length - 1) return; // final

  const nextRound = bracket.rounds[rIndex+1];
  const targetMatch = Math.floor(mIndex/2);
  const targetSlot = mIndex % 2; // 0 -> left, 1 -> right
  const winnerName = match.winnerIndex===0 ? match.p1 : match.p2;

  if(targetSlot===0) nextRound[targetMatch].p1 = winnerName;
  else               nextRound[targetMatch].p2 = winnerName;
}

function clearAdvance(rIndex, mIndex){
  if(rIndex >= bracket.rounds.length - 1) return;
  const nextRound = bracket.rounds[rIndex+1];
  const targetMatch = Math.floor(mIndex/2);
  const targetSlot = mIndex % 2;
  if(targetSlot===0) nextRound[targetMatch].p1 = '';
  else               nextRound[targetMatch].p2 = '';
}

/* ---------- rendering ---------- */
function render(){
  const wrap = $('#bracketWrap');
  const grid = $('#grid');
  if(!bracket){ wrap.style.display='none'; grid.innerHTML=''; return; }
  wrap.style.display='block';
  grid.innerHTML='';

  const totalRounds = bracket.rounds.length;

  bracket.rounds.forEach((matches, rIndex)=>{
    const roundCol = el('div','round');
    roundCol.appendChild(el('div','round-title', titleForRound(rIndex,totalRounds)));

    matches.forEach((m, mIndex)=>{
      const card = el('div','match');

      const s1 = el('div','slot'+(m.p1 ? '' : ' empty'));
      s1.appendChild(el('span','', m.p1 || '‚Äî'));

      const i1 = document.createElement('input');
      i1.type='number'; i1.min='0'; i1.step='1'; i1.className='score';
      if(m.s1!=null) i1.value = m.s1;
      i1.addEventListener('input', ()=> handleScore(rIndex, mIndex, 0, i1.value));
      s1.appendChild(i1);

      const b1 = el('button','win-btn'+(m.winnerIndex===0?' active':''),'Win');
      b1.addEventListener('click', ()=> setWinner(rIndex, mIndex, 0));
      s1.appendChild(b1);

      const vs = el('div','vs','VS');

      const s2 = el('div','slot'+(m.p2 ? '' : ' empty'));
      s2.appendChild(el('span','', m.p2 || '‚Äî'));

      const i2 = document.createElement('input');
      i2.type='number'; i2.min='0'; i2.step='1'; i2.className='score';
      if(m.s2!=null) i2.value = m.s2;
      i2.addEventListener('input', ()=> handleScore(rIndex, mIndex, 1, i2.value));
      s2.appendChild(i2);

      const b2 = el('button','win-btn'+(m.winnerIndex===1?' active':''),'Win');
      b2.addEventListener('click', ()=> setWinner(rIndex, mIndex, 1));
      s2.appendChild(b2);

      // bye hint
      if(m.p1==='bye' && m.p2!=='bye') b2.classList.add('active');
      if(m.p2==='bye' && m.p1!=='bye') b1.classList.add('active');

      card.appendChild(s1); card.appendChild(vs); card.appendChild(s2);
      roundCol.appendChild(card);
    });

    grid.appendChild(roundCol);
  });
}

function setWinner(rIndex, mIndex, winnerIdx){
  const match = bracket.rounds[rIndex][mIndex];
  if(!match) return;
  match.winnerIndex = winnerIdx;
  advanceWinner(rIndex, mIndex);
  autosave();
  render();
}

function handleScore(rIndex, mIndex, side, rawVal){
  const match = bracket.rounds[rIndex][mIndex];
  const val = rawVal === '' ? null : Math.max(0, parseInt(rawVal,10) || 0);
  if(side===0) match.s1 = val;
  else         match.s2 = val;

  if(match.s1!=null && match.s2!=null && match.s1!==match.s2){
    const winnerIdx = match.s1 > match.s2 ? 0 : 1;
    match.winnerIndex = winnerIdx;
    advanceWinner(rIndex, mIndex);
  } else {
    match.winnerIndex = null;
    clearAdvance(rIndex, mIndex);
  }
  autosave();
  render();
}

/* ---------- actions ---------- */
function generateFromTextarea(){
  const names = cleanNames($('#playersBox').value);
  $('#countPill').textContent = `${names.length} players`;
  if(names.length < 2){ alert('Add at least 2 players.'); return; }

  bracket = buildBracket(names);

  // Auto-advance BYEs in round 0
  bracket.rounds[0].forEach((m,i)=>{
    if(m.p1==='bye' && m.p2!=='bye'){ m.winnerIndex=1; advanceWinner(0,i); }
    else if(m.p2==='bye' && m.p1!=='bye'){ m.winnerIndex=0; advanceWinner(0,i); }
  });

  render();
  autosave();
  $('#bracketWrap').scrollIntoView({behavior:'smooth', block:'start'});
}

function exportJSON(){
  if(!bracket){ alert('Nothing to export yet.'); return; }
  const blob = new Blob([JSON.stringify(bracket,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'chalky_bracket.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function importJSON(){
  const input = document.createElement('input');
  input.type='file'; input.accept='application/json';
  input.onchange = e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(!data || !Array.isArray(data.rounds)) throw new Error('Bad format');
        bracket = data; render(); autosave();
        $('#bracketWrap').style.display='block';
      }catch(err){
        alert('Invalid JSON.');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function resetAll(){
  if(confirm('Clear the current bracket and saved data?')){
    bracket = null;
    localStorage.removeItem(storeKey);
    render();
    $('#playersBox').value='';
    $('#countPill').textContent = '0 players';
    $('#bracketWrap').style.display='none';
  }
}

/* ---------- wiring ---------- */
$('#fillBtn').addEventListener('click', ()=>{
  $('#playersBox').value = `Alice
Bob
Charlie
Dana
Eddie
Frank
Georgia
Hector`;
  $('#countPill').textContent = '8 players';
});
$('#playersBox').addEventListener('input', ()=>{
  const n = cleanNames($('#playersBox').value).length;
  $('#countPill').textContent = `${n} players`;
});
$('#genBtn').addEventListener('click', generateFromTextarea);
$('#saveBtn').addEventListener('click', autosave);
$('#exportBtn').addEventListener('click', exportJSON);
$('#importBtn').addEventListener('click', importJSON);
$('#resetBtn').addEventListener('click', resetAll);

/* load autosave on boot */
const saved = loadSaved();
if(saved){
  bracket = saved; render();
  $('#bracketWrap').style.display='block';
}
</script>
</body>
</html>
